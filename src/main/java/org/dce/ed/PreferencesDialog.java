package org.dce.ed;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.GraphicsEnvironment;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.Window;
import java.io.File;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.ButtonGroup;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JColorChooser;
import javax.swing.JComboBox;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import javax.swing.JSlider;
import javax.swing.JSpinner;
import javax.swing.JTabbedPane;
import javax.swing.JTextField;
import javax.swing.SpinnerNumberModel;
import javax.swing.SwingUtilities;
import javax.swing.border.EmptyBorder;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;

import org.dce.ed.exobiology.audit.ExoPredictionDebuggerMain;
import org.dce.ed.ui.EdoUi;
import org.dce.ed.ui.ShowConsoleAction;
import org.dce.ed.util.EdsmQueryTool;
import org.dce.ed.util.GithubMsiUpdater;

/**
 * Preferences dialog for the overlay.
 */
public class PreferencesDialog extends JDialog {

	public final String clientKey;

    // Overlay-tab fields so OK can read them
    private JButton normalBgColorButton;
    private JSlider normalTransparencySlider;
    private JLabel normalTransparencyValueLabel;

    private JButton passThroughBgColorButton;
    private JSlider passThroughTransparencySlider;
    private JLabel passThroughTransparencyValueLabel;

    private JComboBox<String> passThroughHotkeyCombo;
    private JCheckBox nonOverlayAlwaysOnTopCheckBox;

    // Logging-tab fields so OK can read them
    private JCheckBox autoDetectCheckBox;
    private JTextField customPathField;

    // Speech-tab fields so OK can read them
    private JCheckBox speechEnabledCheckBox;
    private JCheckBox speechUseAwsCheckBox;
    private JComboBox<String> speechEngineCombo;
    private JComboBox<String> speechVoiceCombo;
    private JTextField speechRegionField;
    private JTextField speechAwsProfileField;
    private JTextField speechCacheDirField;
    private JTextField speechSampleRateField;

    // Fonts-tab fields
    private JComboBox<String> uiFontNameCombo;
    private JSpinner uiFontSizeSpinner;


    // Colors-tab fields
    private JButton uiMainTextColorButton;
    private JButton uiBackgroundColorButton;

    // Mining-tab fields
    private JTextField prospectorMaterialsField;
    private JSpinner prospectorMinPropSpinner;
    private JSpinner prospectorMinAvgValueSpinner;

    // Mining tab: limpet reminder
    private JCheckBox miningLowLimpetReminderEnabledCheckBox;
    private JRadioButton miningLowLimpetReminderCountRadio;
    private JSpinner miningLowLimpetReminderThresholdSpinner;
    private JRadioButton miningLowLimpetReminderPercentRadio;
    private JSpinner miningLowLimpetReminderPercentSpinner;

    // Mining tab: value estimation (used by Mining tab only)
    private JSpinner miningTonsLowSpinner;
    private JSpinner miningTonsMediumSpinner;
    private JSpinner miningTonsHighSpinner;
    private JSpinner miningTonsCoreSpinner;

    // Text notifications
    private JCheckBox textNotificationsEnabledCheckBox;
    private JTextField textNotificationAddressField;

    private boolean okPressed;
    private final Font originalUiFont;
    private final int originalNormalBgRgb;
    private final int originalNormalTransparencyPct;
    private final int originalPassThroughBgRgb;
    private final int originalPassThroughTransparencyPct;
    private final int originalPassThroughToggleKeyCode;

    private final int originalUiMainTextRgb;
    private final int originalUiBackgroundRgb;

    
    public static final String[] STANDARD_US_ENGLISH_VOICES = new String[] {
            "Joanna",
            "Matthew",
            "Ivy",
            "Justin",
            "Kendra",
            "Kimberly",
            "Joey",
            "Salli"
    };
    
    public PreferencesDialog(java.awt.Window owner, String clientKey) {
        super(owner, "Overlay Preferences", java.awt.Dialog.ModalityType.MODELESS);

        this.clientKey = clientKey;
        this.originalUiFont = OverlayPreferences.getUiFont();

        this.originalNormalBgRgb = OverlayPreferences.getNormalBackgroundRgb();
        this.originalNormalTransparencyPct = OverlayPreferences.getNormalTransparencyPercent();
        this.originalPassThroughBgRgb = OverlayPreferences.getPassThroughBackgroundRgb();
        this.originalPassThroughTransparencyPct = OverlayPreferences.getPassThroughTransparencyPercent();
        this.originalPassThroughToggleKeyCode = OverlayPreferences.getPassThroughToggleKeyCode();

        this.originalUiMainTextRgb = OverlayPreferences.getUiMainTextRgb();
        this.originalUiBackgroundRgb = OverlayPreferences.getUiBackgroundRgb();

        
        this.okPressed = false;
        setDefaultCloseOperation(DISPOSE_ON_CLOSE);
        setLayout(new BorderLayout());
        setMinimumSize(new Dimension(560, 380));

        JTabbedPane tabs = new JTabbedPane();
        tabs.addTab("Overlay", createOverlayPanel());
        tabs.addTab("Logging", createLoggingPanel());
        tabs.addTab("Speech", createSpeechPanel());
        tabs.addTab("Fonts", createFontsPanel());
        tabs.addTab("Colors", createColorsPanel());
        tabs.addTab("Mining", createMiningPanel());
        tabs.addTab("Tools", createToolsPanel());
        
        add(tabs, BorderLayout.CENTER);
        add(createButtonPanel(), BorderLayout.SOUTH);

        pack();
        setLocationRelativeTo(owner);

        // If the user closes the dialog or hits Cancel, revert any live preview.
        addWindowListener(new java.awt.event.WindowAdapter() {
            @Override
            public void windowClosed(java.awt.event.WindowEvent e) {
                revertLivePreviewIfNeeded();
            }

            @Override
            public void windowClosing(java.awt.event.WindowEvent e) {
                revertLivePreviewIfNeeded();
            }
        });
    }

    private JPanel createOverlayPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBorder(new EmptyBorder(10, 10, 10, 10));
        panel.setOpaque(false);

        JPanel content = new JPanel(new GridBagLayout());
        content.setOpaque(false);

        GridBagConstraints outer = new GridBagConstraints();
        outer.gridx = 0;
        outer.gridy = 0;
        outer.fill = GridBagConstraints.HORIZONTAL;
        outer.anchor = GridBagConstraints.NORTHWEST;
        outer.weightx = 1.0;
        outer.insets = new Insets(6, 6, 6, 6);

        // --- Normal mode ---
        JPanel normalPanel = createOverlayAppearanceSection(
                "Normal mode",
                originalNormalBgRgb,
                originalNormalTransparencyPct,
                (btn, slider, valueLabel) -> {
                    normalBgColorButton = btn;
                    normalTransparencySlider = slider;
                    normalTransparencyValueLabel = valueLabel;
                },
                () -> applyLiveOverlayBackgroundPreview(false)
        );

        content.add(normalPanel, outer);

        // --- Pass-through mode ---
        outer.gridy++;
        JPanel ptPanel = createOverlayAppearanceSection(
                "Mouse-pass through mode",
                originalPassThroughBgRgb,
                originalPassThroughTransparencyPct,
                (btn, slider, valueLabel) -> {
                    passThroughBgColorButton = btn;
                    passThroughTransparencySlider = slider;
                    passThroughTransparencyValueLabel = valueLabel;
                },
                () -> applyLiveOverlayBackgroundPreview(true)
        );
        content.add(ptPanel, outer);

        // --- Hotkey ---
        outer.gridy++;
        JPanel hotkeyPanel = new JPanel(new GridBagLayout());
        hotkeyPanel.setOpaque(false);
        hotkeyPanel.setBorder(BorderFactory.createTitledBorder("Controls"));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.anchor = GridBagConstraints.WEST;
        gbc.insets = new Insets(4, 4, 4, 4);

        JLabel hotkeyLabel = new JLabel("Mouse-pass through toggle key:");
        hotkeyPanel.add(hotkeyLabel, gbc);

        gbc.gridx = 1;
        passThroughHotkeyCombo = new JComboBox<>(buildFunctionKeyChoices());
        passThroughHotkeyCombo.setSelectedItem(keyCodeToDisplayString(originalPassThroughToggleKeyCode));
        hotkeyPanel.add(passThroughHotkeyCombo, gbc);

        gbc.gridx = 0;
        gbc.gridy++;
        gbc.gridwidth = 2;

        nonOverlayAlwaysOnTopCheckBox = new JCheckBox("Always on top (non-overlay mode)");
        nonOverlayAlwaysOnTopCheckBox.setOpaque(false);
        nonOverlayAlwaysOnTopCheckBox.setSelected(OverlayPreferences.isNonOverlayAlwaysOnTop());
        hotkeyPanel.add(nonOverlayAlwaysOnTopCheckBox, gbc);

        gbc.gridwidth = 1;
        
        content.add(hotkeyPanel, outer);

        panel.add(content, BorderLayout.NORTH);
        return panel;
    }

    /**
     * Logging tab: choose between auto-detected live folder and a custom test folder.
     */
    private JPanel createLoggingPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBorder(new EmptyBorder(10, 10, 10, 10));
        panel.setOpaque(false);

        JPanel content = new JPanel(new GridBagLayout());
        content.setOpaque(false);

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.anchor = GridBagConstraints.WEST;
        gbc.insets = new Insets(4, 4, 4, 4);

        // --- Auto-detect checkbox ---
        JLabel journalLabel = new JLabel("Use auto-detected ED log folder:");
        autoDetectCheckBox = new JCheckBox();
        autoDetectCheckBox.setOpaque(false);

        // Load current prefs
        boolean auto = OverlayPreferences.isAutoLogDir(clientKey);
        autoDetectCheckBox.setSelected(auto);

        content.add(journalLabel, gbc);
        gbc.gridx = 1;
        content.add(autoDetectCheckBox, gbc);

        // --- Custom path field + browse button ---
        gbc.gridx = 0;
        gbc.gridy++;
        JLabel pathLabel = new JLabel("Custom journal folder:");
        content.add(pathLabel, gbc);

        gbc.gridx = 1;
        JPanel pathPanel = new JPanel(new BorderLayout(4, 0));
        pathPanel.setOpaque(false);

        customPathField = new JTextField(28);
        customPathField.setText(OverlayPreferences.getCustomLogDir(clientKey));

        JButton browseButton = new JButton("Browse.");
        browseButton.addActionListener(e -> {
            JFileChooser chooser = new JFileChooser();
            chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
            chooser.setDialogTitle("Select Elite Dangerous journal folder");
            String existing = customPathField.getText().trim();
            if (!existing.isEmpty()) {
                File f = new File(existing);
                if (f.isDirectory()) {
                    chooser.setCurrentDirectory(f);
                }
            }
            int result = chooser.showOpenDialog(PreferencesDialog.this);
            if (result == JFileChooser.APPROVE_OPTION && chooser.getSelectedFile() != null) {
                customPathField.setText(chooser.getSelectedFile().getAbsolutePath());
            }
        });

        pathPanel.add(customPathField, BorderLayout.CENTER);
        pathPanel.add(browseButton, BorderLayout.EAST);
        content.add(pathPanel, gbc);

        // Enable/disable fields based on auto-detect state
        Runnable updateEnabled = () -> {
            boolean useAuto = autoDetectCheckBox.isSelected();
            customPathField.setEnabled(!useAuto);
            browseButton.setEnabled(!useAuto);
        };
        autoDetectCheckBox.addActionListener(e -> updateEnabled.run());
        updateEnabled.run();

        panel.add(content, BorderLayout.NORTH);
        return panel;
    }

    
    private JPanel createFontsPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBorder(new EmptyBorder(10, 10, 10, 10));
        panel.setOpaque(false);

        JPanel content = new JPanel(new GridBagLayout());
        content.setOpaque(false);

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.anchor = GridBagConstraints.WEST;
        gbc.insets = new Insets(6, 6, 6, 6);

        // Font family
        JLabel fontLabel = new JLabel("Font:");
        content.add(fontLabel, gbc);

        gbc.gridx = 1;
        String[] families = GraphicsEnvironment.getLocalGraphicsEnvironment()
                .getAvailableFontFamilyNames();
        uiFontNameCombo = new JComboBox<>(families);
        uiFontNameCombo.setSelectedItem(OverlayPreferences.getUiFontName());
        uiFontNameCombo.setPrototypeDisplayValue("Segoe UI Semibold");
        content.add(uiFontNameCombo, gbc);

        // Font size
        gbc.gridx = 0;
        gbc.gridy++;
        JLabel sizeLabel = new JLabel("Size:");
        content.add(sizeLabel, gbc);

        gbc.gridx = 1;
        int sz = OverlayPreferences.getUiFontSize();
        uiFontSizeSpinner = new JSpinner(new SpinnerNumberModel(sz, 8, 72, 1));
        ((JSpinner.DefaultEditor) uiFontSizeSpinner.getEditor()).getTextField().setColumns(4);
        content.add(uiFontSizeSpinner, gbc);

        // Preview
        gbc.gridx = 0;
        gbc.gridy++;
        gbc.gridwidth = 2;

        uiFontNameCombo.addActionListener(e -> updatePreviewLabelFont());
        uiFontSizeSpinner.addChangeListener(e -> updatePreviewLabelFont());

        panel.add(content, BorderLayout.NORTH);
        return panel;
    }


    private JPanel createColorsPanel() {
        JPanel panel = new JPanel();
        panel.setOpaque(false);
        panel.setLayout(new BoxLayout(panel, BoxLayout.Y_AXIS));
        panel.setBorder(new EmptyBorder(10, 10, 10, 10));

        int initialMainRgb = OverlayPreferences.getUiMainTextRgb();
        int initialBgRgb = OverlayPreferences.getUiBackgroundRgb();

        JPanel grid = new JPanel(new GridBagLayout());
        grid.setOpaque(false);

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.anchor = GridBagConstraints.WEST;
        gbc.insets = new Insets(6, 6, 6, 6);

        grid.add(new JLabel("Main text:"), gbc);

        gbc.gridx = 1;
        uiMainTextColorButton = new JButton("Choose...");
        uiMainTextColorButton.setBackground(rgbToColor(initialMainRgb));
        uiMainTextColorButton.setOpaque(true);
        uiMainTextColorButton.addActionListener(e -> {
            Color chosen = JColorChooser.showDialog(this, "Choose main text color", uiMainTextColorButton.getBackground());
            if (chosen != null) {
                uiMainTextColorButton.setBackground(chosen);
                applyLiveColorPreviewFromButtons();
            }
        });
        grid.add(uiMainTextColorButton, gbc);

        gbc.gridx = 0;
        gbc.gridy++;
        grid.add(new JLabel("Background:"), gbc);

        gbc.gridx = 1;
        uiBackgroundColorButton = new JButton("Choose...");
        uiBackgroundColorButton.setBackground(rgbToColor(initialBgRgb));
        uiBackgroundColorButton.setOpaque(true);
        uiBackgroundColorButton.addActionListener(e -> {
            Color chosen = JColorChooser.showDialog(this, "Choose background color", uiBackgroundColorButton.getBackground());
            if (chosen != null) {
                uiBackgroundColorButton.setBackground(chosen);
                applyLiveColorPreviewFromButtons();
            }
        });
        grid.add(uiBackgroundColorButton, gbc);

        gbc.gridx = 0;
        gbc.gridy++;
        gbc.gridwidth = 2;
        gbc.anchor = GridBagConstraints.CENTER;

        JButton resetColorsButton = new JButton("Reset to defaults");
        resetColorsButton.addActionListener(e -> {
            uiMainTextColorButton.setBackground(new Color(255, 140, 0));
            uiBackgroundColorButton.setBackground(new Color(10, 10, 10));
            applyLiveColorPreviewFromButtons();
        });
        grid.add(resetColorsButton, gbc);

        panel.add(grid);
        panel.add(Box.createVerticalGlue());

        return panel;
    }
    private void applyLiveColorPreviewFromButtons() {
        if (uiMainTextColorButton == null || uiBackgroundColorButton == null) {
            return;
        }
        int mainRgb = colorToRgb(uiMainTextColorButton.getBackground());
        int bgRgb = colorToRgb(uiBackgroundColorButton.getBackground());
        applyLiveColorPreview(mainRgb, bgRgb);
    }

    private void applyLiveColorPreview(int mainRgb, int bgRgb) {
        // Live preview: write to preferences so the existing theme plumbing picks it up.
        // If the user cancels, revertLivePreviewIfNeeded() restores the original values.
        OverlayPreferences.setUiMainTextRgb(mainRgb);
        OverlayPreferences.setUiBackgroundRgb(bgRgb);
        OverlayPreferences.applyThemeToEdoUi();

        if (getOwner() instanceof OverlayUiPreviewHost) {
            OverlayUiPreviewHost f = (OverlayUiPreviewHost) getOwner();
            f.applyThemeFromPreferences();

            boolean pt = f.isPassThroughEnabled();
            int pct;
            if (pt) {
                pct = passThroughTransparencySlider != null
                        ? passThroughTransparencySlider.getValue()
                        : originalPassThroughTransparencyPct;
            } else {
                pct = normalTransparencySlider != null
                        ? normalTransparencySlider.getValue()
                        : originalNormalTransparencyPct;
            }

            // Also preview overlay background using the chosen theme background color
            f.applyOverlayBackgroundPreview(pt, bgRgb, pct);
        }
    }

    private JPanel createMiningPanel() {
    	JPanel panel = new JPanel(new BorderLayout());
    	panel.setBorder(new EmptyBorder(10, 10, 10, 10));
    	panel.setOpaque(false);

    	JPanel outer = new JPanel();
    	outer.setOpaque(false);
    	outer.setLayout(new BoxLayout(outer, BoxLayout.Y_AXIS));

    	// -----------------------------------------------------------------
    	// Prospector box
    	// -----------------------------------------------------------------
    	JPanel prospectorBox = new JPanel(new GridBagLayout());
    	prospectorBox.setOpaque(false);
    	prospectorBox.setBorder(
    			BorderFactory.createTitledBorder(
    				BorderFactory.createLineBorder(EdoUi.Internal.GRAY_120),
    				"Prospector"
    			)
    		);


    	GridBagConstraints gbc = new GridBagConstraints();
    	gbc.gridx = 0;
    	gbc.gridy = 0;
    	gbc.anchor = GridBagConstraints.WEST;
    	gbc.insets = new Insets(6, 8, 6, 8);

    	JLabel materialsLabel = new JLabel("Materials (comma separated):");
    	prospectorBox.add(materialsLabel, gbc);

    	gbc.gridx = 1;
    	gbc.fill = GridBagConstraints.HORIZONTAL;
    	gbc.weightx = 1.0;

    	prospectorMaterialsField = new JTextField(32);
    	prospectorMaterialsField.setText(OverlayPreferences.getProspectorMaterialsCsv());
    	prospectorBox.add(prospectorMaterialsField, gbc);

    	gbc.gridx = 2;
    	gbc.fill = GridBagConstraints.NONE;
    	gbc.weightx = 0.0;

    	JLabel minPropLabel = new JLabel("Min%:");
    	prospectorBox.add(minPropLabel, gbc);

    	gbc.gridx = 3;
    	double currentProp = OverlayPreferences.getProspectorMinProportionPercent();
    	prospectorMinPropSpinner = new JSpinner(new SpinnerNumberModel(currentProp, 0.0, 100.0, 1.0));
    	((JSpinner.DefaultEditor) prospectorMinPropSpinner.getEditor()).getTextField().setColumns(6);
    	prospectorBox.add(prospectorMinPropSpinner, gbc);

    	gbc.gridx = 0;
    	gbc.gridy++;
    	JLabel minAvgValueLabel = new JLabel("Minimum galactic avg value (Cr/t):");
    	prospectorBox.add(minAvgValueLabel, gbc);

    	gbc.gridx = 1;
    	int currentAvg = OverlayPreferences.getProspectorMinAvgValueCrPerTon();
    	prospectorMinAvgValueSpinner = new JSpinner(new SpinnerNumberModel(currentAvg, 0, 10_000_000, 1000));
    	((JSpinner.DefaultEditor) prospectorMinAvgValueSpinner.getEditor()).getTextField().setColumns(8);
    	prospectorBox.add(prospectorMinAvgValueSpinner, gbc);

    	gbc.gridx = 0;
    	gbc.gridy++;
    	gbc.gridwidth = 4;
    	JLabel hint = new JLabel("Tip: leave materials blank to announce ANY material above the thresholds.");
    	prospectorBox.add(hint, gbc);

    	outer.add(prospectorBox);
    	outer.add(Box.createVerticalStrut(10));
    	
    	// -----------------------------------------------------------------
    	// Limpet reminder (checkbox + two radio rows)
    	// -----------------------------------------------------------------
    	JPanel limpetPanel = new JPanel();
    	limpetPanel.setOpaque(false);
    	limpetPanel.setLayout(new BoxLayout(limpetPanel, BoxLayout.Y_AXIS));

    	JPanel limpetCheckRow = new JPanel(new FlowLayout(FlowLayout.LEFT, 8, 0));
    	limpetCheckRow.setOpaque(false);

    	miningLowLimpetReminderEnabledCheckBox = new JCheckBox("Low limpet announcement");
    	miningLowLimpetReminderEnabledCheckBox.setOpaque(false);
    	miningLowLimpetReminderEnabledCheckBox.setSelected(OverlayPreferences.isMiningLowLimpetReminderEnabled());

    	limpetCheckRow.add(miningLowLimpetReminderEnabledCheckBox);
    	limpetPanel.add(limpetCheckRow);

    	// Row 1: COUNT (indented)
    	JPanel limpetCountRow = new JPanel(new FlowLayout(FlowLayout.LEFT, 8, 0));
    	limpetCountRow.setOpaque(false);
    	limpetCountRow.add(Box.createHorizontalStrut(28)); // ~4 spaces indent

    	miningLowLimpetReminderCountRadio = new JRadioButton("Remind if limpets <");
    	miningLowLimpetReminderCountRadio.setOpaque(false);

    	ButtonGroup limpetModeGroup = new ButtonGroup();
    	limpetModeGroup.add(miningLowLimpetReminderCountRadio);
    	limpetCountRow.add(miningLowLimpetReminderCountRadio);

    	int currentCountThreshold = OverlayPreferences.getMiningLowLimpetReminderThreshold();
    	miningLowLimpetReminderThresholdSpinner =
    	        new JSpinner(new SpinnerNumberModel(currentCountThreshold, 0, 10_000, 1));
    	JSpinner.DefaultEditor countEd = (JSpinner.DefaultEditor) miningLowLimpetReminderThresholdSpinner.getEditor();
    	countEd.getTextField().setColumns(5);
    	limpetCountRow.add(miningLowLimpetReminderThresholdSpinner);

    	JLabel limpetCountUnitsLabel = new JLabel("limpets");
    	limpetCountRow.add(limpetCountUnitsLabel);

    	limpetPanel.add(limpetCountRow);

    	// Row 2: PERCENT (indented)
    	JPanel limpetPercentRow = new JPanel(new FlowLayout(FlowLayout.LEFT, 8, 0));
    	limpetPercentRow.setOpaque(false);
    	limpetPercentRow.add(Box.createHorizontalStrut(28)); // ~4 spaces indent

    	miningLowLimpetReminderPercentRadio = new JRadioButton("Remind if limpets <");
    	miningLowLimpetReminderPercentRadio.setOpaque(false);
    	limpetModeGroup.add(miningLowLimpetReminderPercentRadio);
    	limpetPercentRow.add(miningLowLimpetReminderPercentRadio);

    	int currentPercentThreshold = OverlayPreferences.getMiningLowLimpetReminderThresholdPercent();
    	miningLowLimpetReminderPercentSpinner =
    	        new JSpinner(new SpinnerNumberModel(currentPercentThreshold, 0, 100, 1));
    	JSpinner.DefaultEditor percentEd = (JSpinner.DefaultEditor) miningLowLimpetReminderPercentSpinner.getEditor();
    	percentEd.getTextField().setColumns(5); // same as count (width consistency)
    	limpetPercentRow.add(miningLowLimpetReminderPercentSpinner);

    	JLabel limpetPercentUnitsLabel = new JLabel("% of cargo capacity");
    	limpetPercentRow.add(limpetPercentUnitsLabel);

    	limpetPanel.add(limpetPercentRow);

    	// Force both spinners to the same preferred size (whichever is wider)
    	Dimension s1 = miningLowLimpetReminderThresholdSpinner.getPreferredSize();
    	Dimension s2 = miningLowLimpetReminderPercentSpinner.getPreferredSize();
    	int w = Math.max(s1.width, s2.width);
    	int h = Math.max(s1.height, s2.height);
    	Dimension same = new Dimension(w, h);
    	miningLowLimpetReminderThresholdSpinner.setPreferredSize(same);
    	miningLowLimpetReminderPercentSpinner.setPreferredSize(same);

    	// Initialize mode selection
    	OverlayPreferences.MiningLimpetReminderMode mode = OverlayPreferences.getMiningLowLimpetReminderMode();
    	if (mode == OverlayPreferences.MiningLimpetReminderMode.PERCENT) {
    	    miningLowLimpetReminderPercentRadio.setSelected(true);
    	} else {
    	    miningLowLimpetReminderCountRadio.setSelected(true);
    	}

    	Runnable updateLimpetEnabled = () -> {
    	    boolean enabled = miningLowLimpetReminderEnabledCheckBox.isSelected();
    	    boolean percentSelected = miningLowLimpetReminderPercentRadio.isSelected();
    	    boolean countSelected = !percentSelected;

    	    // Radios themselves should remain clickable when enabled
    	    miningLowLimpetReminderCountRadio.setEnabled(enabled);
    	    miningLowLimpetReminderPercentRadio.setEnabled(enabled);

    	    // COUNT line: disable everything except the radio when not selected
    	    miningLowLimpetReminderThresholdSpinner.setEnabled(enabled && countSelected);
    	    limpetCountUnitsLabel.setEnabled(enabled && countSelected);

    	    // PERCENT line: disable everything except the radio when not selected
    	    miningLowLimpetReminderPercentSpinner.setEnabled(enabled && percentSelected);
    	    limpetPercentUnitsLabel.setEnabled(enabled && percentSelected);
    	};

    	miningLowLimpetReminderEnabledCheckBox.addActionListener(e -> updateLimpetEnabled.run());
    	miningLowLimpetReminderCountRadio.addActionListener(e -> updateLimpetEnabled.run());
    	miningLowLimpetReminderPercentRadio.addActionListener(e -> updateLimpetEnabled.run());
    	updateLimpetEnabled.run();


    	limpetPanel.setAlignmentX(JPanel.LEFT_ALIGNMENT);
    	JPanel limpetWrap = new JPanel(new BorderLayout());
    	limpetWrap.setOpaque(false);
    	limpetWrap.add(limpetPanel, BorderLayout.WEST);

    	outer.add(limpetWrap);
    	outer.add(Box.createVerticalStrut(10));

    	// -----------------------------------------------------------------
    	// Value estimation box
    	// -----------------------------------------------------------------
    	JPanel estBox = new JPanel(new GridBagLayout());
    	estBox.setOpaque(false);
    	estBox.setBorder(
    			BorderFactory.createTitledBorder(
    				BorderFactory.createLineBorder(EdoUi.Internal.GRAY_120),
    				"Mining tab value estimation (tons)"
    			)
    		);


    	GridBagConstraints ebc = new GridBagConstraints();
    	ebc.gridx = 0;
    	ebc.gridy = 0;
    	ebc.anchor = GridBagConstraints.WEST;
    	ebc.insets = new Insets(6, 8, 6, 8);

    	JLabel lowTonsLabel = new JLabel("Content=Low total tons:");
    	estBox.add(lowTonsLabel, ebc);

    	ebc.gridx = 1;
    	miningTonsLowSpinner = new JSpinner(new SpinnerNumberModel(OverlayPreferences.getMiningEstimateTonsLow(), 0.0, 200.0, 1.0));
    	((JSpinner.DefaultEditor) miningTonsLowSpinner.getEditor()).getTextField().setColumns(6);
    	estBox.add(miningTonsLowSpinner, ebc);

    	ebc.gridx = 0;
    	ebc.gridy++;
    	JLabel medTonsLabel = new JLabel("Content=Medium total tons:");
    	estBox.add(medTonsLabel, ebc);

    	ebc.gridx = 1;
    	miningTonsMediumSpinner = new JSpinner(new SpinnerNumberModel(OverlayPreferences.getMiningEstimateTonsMedium(), 0.0, 200.0, 1.0));
    	((JSpinner.DefaultEditor) miningTonsMediumSpinner.getEditor()).getTextField().setColumns(6);
    	estBox.add(miningTonsMediumSpinner, ebc);

    	ebc.gridx = 0;
    	ebc.gridy++;
    	JLabel highTonsLabel = new JLabel("Content=High total tons:");
    	estBox.add(highTonsLabel, ebc);

    	ebc.gridx = 1;
    	miningTonsHighSpinner = new JSpinner(new SpinnerNumberModel(OverlayPreferences.getMiningEstimateTonsHigh(), 0.0, 200.0, 1.0));
    	((JSpinner.DefaultEditor) miningTonsHighSpinner.getEditor()).getTextField().setColumns(6);
    	estBox.add(miningTonsHighSpinner, ebc);

    	ebc.gridx = 0;
    	ebc.gridy++;
    	JLabel coreTonsLabel = new JLabel("Core total tons:");
    	estBox.add(coreTonsLabel, ebc);

    	ebc.gridx = 1;
    	miningTonsCoreSpinner = new JSpinner(new SpinnerNumberModel(OverlayPreferences.getMiningEstimateTonsCore(), 0.0, 200.0, 1.0));
    	((JSpinner.DefaultEditor) miningTonsCoreSpinner.getEditor()).getTextField().setColumns(6);
    	estBox.add(miningTonsCoreSpinner, ebc);

    	outer.add(estBox);

    	panel.add(outer, BorderLayout.NORTH);
    	return panel;
    }
    
    private JPanel createToolsPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBorder(new EmptyBorder(10, 10, 10, 10));
        panel.setOpaque(false);

        JPanel content = new JPanel(new GridBagLayout());
        content.setOpaque(false);

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.anchor = GridBagConstraints.NORTHWEST;
        gbc.insets = new Insets(6, 6, 6, 6);

        JButton launchLogMonitorButton = new JButton("Journal Monitor");
        launchLogMonitorButton.addActionListener(e -> launchJournalMonitor());

        JButton launchEdsmQueryToolsButton = new JButton("Run EDSM Query Tools");
        launchEdsmQueryToolsButton.addActionListener(e -> launchEdsmQueryTools());

        JButton launchExoPredictionDebuggerButton = new JButton("Exo Prediction Debugger");
        launchExoPredictionDebuggerButton.addActionListener(e -> launchExoPredictionDebugger());

        JButton showConsole = new JButton("Show console");
        showConsole.addActionListener(new ShowConsoleAction());

        JButton checkForUpdatesButton = new JButton("Check for Updates");
        checkForUpdatesButton.addActionListener(e -> GithubMsiUpdater.checkAndUpdate(this));

        // --- Text notifications (email-to-SMS gateways like vtext.com) ---
        JPanel textNotifPanel = new JPanel(new GridBagLayout());
        textNotifPanel.setOpaque(false);
        textNotifPanel.setBorder(BorderFactory.createTitledBorder("Text notifications"));

        GridBagConstraints tgbc = new GridBagConstraints();
        tgbc.gridx = 0;
        tgbc.gridy = 0;
        tgbc.anchor = GridBagConstraints.WEST;
        tgbc.insets = new Insets(4, 4, 4, 4);

        JLabel enableTextLabel = new JLabel("Enable text notifications:");
        textNotifPanel.add(enableTextLabel, tgbc);

        tgbc.gridx = 1;
        textNotificationsEnabledCheckBox = new JCheckBox();
        textNotificationsEnabledCheckBox.setOpaque(false);
        textNotificationsEnabledCheckBox.setSelected(OverlayPreferences.isTextNotificationsEnabled());
        textNotifPanel.add(textNotificationsEnabledCheckBox, tgbc);

        tgbc.gridx = 0;
        tgbc.gridy++;
        JLabel addressLabel = new JLabel("Text address:");
        textNotifPanel.add(addressLabel, tgbc);

        tgbc.gridx = 1;
        textNotificationAddressField = new JTextField(24);
        
        List<String> textNotificationAddress = OverlayPreferences.getTextNotificationAddress();
        textNotificationAddressField.setText(textNotificationAddress 
        		.stream()
                .filter(Objects::nonNull)
                .collect(Collectors.joining(", ")));
        textNotifPanel.add(textNotificationAddressField, tgbc);

        Runnable updateTextEnabled = () -> {
            boolean enabled = textNotificationsEnabledCheckBox.isSelected();
            textNotificationAddressField.setEnabled(enabled);
        };
        textNotificationsEnabledCheckBox.addActionListener(e -> updateTextEnabled.run());
        updateTextEnabled.run();

        content.add(launchLogMonitorButton, gbc);

        gbc.gridy++;
        content.add(launchEdsmQueryToolsButton, gbc);

        gbc.gridy++;
        content.add(launchExoPredictionDebuggerButton, gbc);

        gbc.gridy++;
        content.add(showConsole, gbc);

        gbc.gridy++;
        content.add(checkForUpdatesButton, gbc);

        gbc.gridy++;
        content.add(textNotifPanel, gbc);

        gbc.gridy++;
        gbc.weighty = 1.0;
        content.add(new JLabel(""), gbc);

        panel.add(content, BorderLayout.NORTH);
        return panel;
    }

    private void launchJournalMonitor() {
        // Prefer StandaloneLogMonitor if you have it; fall back to StandaloneLogViewer (which exists in this project).
        SwingUtilities.invokeLater(() -> {
            try {
                Class<?> clazz = Class.forName("org.dce.ed.StandaloneLogMonitor");
                clazz.getMethod("main", String[].class).invoke(null, (Object) new String[0]);
                return;
            } catch (Exception ignore) {
                // fall through
            }

            try {
                StandaloneLogViewer.main(new String[0]);
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this,
                        "Unable to launch the standalone log monitor:\n" + ex.getMessage(),
                        "Launch Error",
                        JOptionPane.ERROR_MESSAGE);
            }
        });
    }

    private void launchEdsmQueryTools() {
        SwingUtilities.invokeLater(() -> {
            try {
                new EdsmQueryTool().setVisible(true);
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this,
                        "Unable to launch EDSM Query Tools:\n" + ex.getMessage(),
                        "Launch Error",
                        JOptionPane.ERROR_MESSAGE);
            }
        });
    }

    private void launchExoPredictionDebugger() {
        SwingUtilities.invokeLater(() -> {
            try {
                ExoPredictionDebuggerMain.main(new String[0]);
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this,
                        "Unable to launch Exo Prediction Debugger:\n" + ex.getMessage(),
                        "Launch Error",
                        JOptionPane.ERROR_MESSAGE);
            }
        });
    }


    private void updatePreviewLabelFont() {
        Font f = buildSelectedUiFont();
        applyLivePreview(f);
    }

    private Font buildSelectedUiFont() {
        String name = (String) uiFontNameCombo.getSelectedItem();
        int size = 17;
        try {
            size = ((Number) uiFontSizeSpinner.getValue()).intValue();
        } catch (Exception e) {
            // ignore
        }
        if (name == null || name.isBlank()) {
            name = originalUiFont.getName();
        }
        return new Font(name, Font.PLAIN, size);
    }

    private void applyLivePreview(Font font) {
        if (getOwner() instanceof OverlayUiPreviewHost) {
            ((OverlayUiPreviewHost) getOwner()).applyUiFontPreview(font);
        }
    }

    private void applyLivePreviewToOverlay() {
        if (!(getOwner() instanceof OverlayUiPreviewHost)) {
            return;
        }

        String name = (String) uiFontNameCombo.getSelectedItem();
        int size = 17;
        try {
            size = ((Number) uiFontSizeSpinner.getValue()).intValue();
        } catch (Exception e) {
            // ignore
        }

        Font font = new Font(name, Font.PLAIN, size);
        ((OverlayUiPreviewHost) getOwner()).applyUiFontPreview(font);
    }

    private void revertLivePreviewIfNeeded() {
        if (okPressed) {
            return;
        }
        if (!(getOwner() instanceof OverlayUiPreviewHost)) {
            return;
        }

        OverlayUiPreviewHost f = (OverlayUiPreviewHost) getOwner();

        // Revert theme colors
        OverlayPreferences.setUiMainTextRgb(originalUiMainTextRgb);
        OverlayPreferences.setUiBackgroundRgb(originalUiBackgroundRgb);
        OverlayPreferences.applyThemeToEdoUi();
        f.applyThemeFromPreferences();

        // Revert font
        f.applyUiFontPreview(originalUiFont);

        // Revert overlay background preview
        boolean pt = f.isPassThroughEnabled();
        int rgb = pt ? originalPassThroughBgRgb : originalNormalBgRgb;
        int pct = pt ? originalPassThroughTransparencyPct : originalNormalTransparencyPct;
        f.applyOverlayBackgroundPreview(pt, rgb, pct);
    }

private JPanel createSpeechPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBorder(new EmptyBorder(10, 10, 10, 10));
        panel.setOpaque(false);

        JPanel content = new JPanel(new GridBagLayout());
        content.setOpaque(false);

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.anchor = GridBagConstraints.WEST;
        gbc.insets = new Insets(4, 4, 4, 4);

        // Enabled
        JLabel enabledLabel = new JLabel("Enable speech (Amazon Polly):");
        speechEnabledCheckBox = new JCheckBox();
        speechEnabledCheckBox.setOpaque(false);
        speechEnabledCheckBox.setSelected(OverlayPreferences.isSpeechEnabled());

        content.add(enabledLabel, gbc);
        gbc.gridx = 1;
        content.add(speechEnabledCheckBox, gbc);


// Use AWS to generate missing speech
gbc.gridx = 0;
gbc.gridy++;
JLabel useAwsLabel = new JLabel("Use AWS to generate speech:");
content.add(useAwsLabel, gbc);

gbc.gridx = 1;
speechUseAwsCheckBox = new JCheckBox();
speechUseAwsCheckBox.setOpaque(false);
speechUseAwsCheckBox.setSelected(OverlayPreferences.isSpeechUseAwsSynthesis());
content.add(speechUseAwsCheckBox, gbc);


        // Engine (Standard only by default)
        gbc.gridx = 0;
        gbc.gridy++;
        JLabel engineLabel = new JLabel("Engine:");
        content.add(engineLabel, gbc);

        gbc.gridx = 1;
        speechEngineCombo = new JComboBox<>(new String[] { "standard", "neural" });
        speechEngineCombo.setSelectedItem(OverlayPreferences.getSpeechEngine());
        content.add(speechEngineCombo, gbc);

        // Voice (keep list small and “safe”)
        gbc.gridx = 0;
        gbc.gridy++;
        JLabel voiceLabel = new JLabel("Voice (Standard):");
        content.add(voiceLabel, gbc);

        gbc.gridx = 1;
        speechVoiceCombo = new JComboBox<>(STANDARD_US_ENGLISH_VOICES);
        speechVoiceCombo.setSelectedItem(OverlayPreferences.getSpeechVoiceName());
        content.add(speechVoiceCombo, gbc);

        // Region
        gbc.gridx = 0;
        gbc.gridy++;
        JLabel regionLabel = new JLabel("AWS Region:");
        content.add(regionLabel, gbc);

        gbc.gridx = 1;
        speechRegionField = new JTextField(12);
        speechRegionField.setText(OverlayPreferences.getSpeechAwsRegion());
        content.add(speechRegionField, gbc);

        // Profile
        gbc.gridx = 0;
        gbc.gridy++;
        JLabel profileLabel = new JLabel("AWS profile (optional):");
        content.add(profileLabel, gbc);

        gbc.gridx = 1;
        speechAwsProfileField = new JTextField(18);
        speechAwsProfileField.setText(OverlayPreferences.getSpeechAwsProfile());
        content.add(speechAwsProfileField, gbc);

        // Cache dir
        gbc.gridx = 0;
        gbc.gridy++;
        JLabel cacheDirLabel = new JLabel("Cache directory:");
        content.add(cacheDirLabel, gbc);

        gbc.gridx = 1;
        JPanel cachePanel = new JPanel(new BorderLayout(4, 0));
        cachePanel.setOpaque(false);

        speechCacheDirField = new JTextField(28);
        speechCacheDirField.setText(OverlayPreferences.getSpeechCacheDir().toString());

        JButton browseCacheButton = new JButton("Browse.");
        browseCacheButton.addActionListener(e -> {
            JFileChooser chooser = new JFileChooser();
            chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
            chooser.setDialogTitle("Select speech cache folder");
            String existing = speechCacheDirField.getText().trim();
            if (!existing.isEmpty()) {
                File f = new File(existing);
                if (f.isDirectory()) {
                    chooser.setCurrentDirectory(f);
                }
            }
            int result = chooser.showOpenDialog(PreferencesDialog.this);
            if (result == JFileChooser.APPROVE_OPTION && chooser.getSelectedFile() != null) {
                speechCacheDirField.setText(chooser.getSelectedFile().getAbsolutePath());
            }
        });

        cachePanel.add(speechCacheDirField, BorderLayout.CENTER);
        cachePanel.add(browseCacheButton, BorderLayout.EAST);
        content.add(cachePanel, gbc);

        // Sample rate (PCM)
        gbc.gridx = 0;
        gbc.gridy++;
        JLabel rateLabel = new JLabel("PCM sample rate (Hz):");
        content.add(rateLabel, gbc);

        gbc.gridx = 1;
        speechSampleRateField = new JTextField(8);
        speechSampleRateField.setText(Integer.toString(OverlayPreferences.getSpeechSampleRateHz()));
        content.add(speechSampleRateField, gbc);

        // Enable/disable everything but the checkbox based on enabled
        Runnable updateEnabled = () -> {
            boolean enabled = speechEnabledCheckBox.isSelected();
            speechEngineCombo.setEnabled(enabled);
            speechVoiceCombo.setEnabled(enabled);
            speechRegionField.setEnabled(enabled);
            speechAwsProfileField.setEnabled(enabled);
            speechCacheDirField.setEnabled(enabled);
            browseCacheButton.setEnabled(enabled);
            speechSampleRateField.setEnabled(enabled);
            speechUseAwsCheckBox.setEnabled(enabled);
        };
        speechEnabledCheckBox.addActionListener(e -> updateEnabled.run());
        updateEnabled.run();

        panel.add(content, BorderLayout.NORTH);
        return panel;
    }

    private JPanel createButtonPanel() {
        JPanel panel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        panel.setBorder(new EmptyBorder(8, 8, 8, 8));
        panel.setOpaque(false);

        JButton ok = new JButton("OK");
        JButton cancel = new JButton("Cancel");

        ok.addActionListener(e -> {
            okPressed = true;
            applyAndSavePreferences();

            if (getOwner() instanceof OverlayUiPreviewHost) {
                OverlayUiPreviewHost f = (OverlayUiPreviewHost) getOwner();
                f.applyOverlayBackgroundFromPreferences(f.isPassThroughEnabled());
                f.applyUiFontPreferences();
                f.applyThemeFromPreferences();

                if (!f.isPassThroughEnabled()) {
                    if (getOwner() instanceof Window) {
                        Window w = (Window) getOwner();
                        w.setAlwaysOnTop(OverlayPreferences.isNonOverlayAlwaysOnTop());
                    }
                }
            }

            dispose();
        });

        cancel.addActionListener(e -> {
            revertLivePreviewIfNeeded();
            dispose();
        });

        panel.add(cancel);
        panel.add(ok);
        return panel;
    }

    private void applyAndSavePreferences() {
        // Overlay tab
        if (normalBgColorButton != null) {
            OverlayPreferences.setNormalBackgroundRgb(colorToRgb(normalBgColorButton.getBackground()));
        }
        if (normalTransparencySlider != null) {
            OverlayPreferences.setNormalTransparencyPercent(normalTransparencySlider.getValue());
        }
        if (passThroughBgColorButton != null) {
            OverlayPreferences.setPassThroughBackgroundRgb(colorToRgb(passThroughBgColorButton.getBackground()));
        }
        if (passThroughTransparencySlider != null) {
            OverlayPreferences.setPassThroughTransparencyPercent(passThroughTransparencySlider.getValue());
        }
        if (passThroughHotkeyCombo != null && passThroughHotkeyCombo.getSelectedItem() != null) {
            int keyCode = displayStringToKeyCode(passThroughHotkeyCombo.getSelectedItem().toString());
            OverlayPreferences.setPassThroughToggleKeyCode(keyCode);
        }

        if (nonOverlayAlwaysOnTopCheckBox != null) {
            OverlayPreferences.setNonOverlayAlwaysOnTop(nonOverlayAlwaysOnTopCheckBox.isSelected());
        }
        
        // Logging tab
        if (autoDetectCheckBox != null && customPathField != null) {
            boolean auto = autoDetectCheckBox.isSelected();
            OverlayPreferences.setAutoLogDir(clientKey, auto);
            if (!auto) {
                OverlayPreferences.setCustomLogDir(clientKey, customPathField.getText().trim());
            }
        }

        // Speech tab
        if (speechEnabledCheckBox != null) {
            OverlayPreferences.setSpeechEnabled(speechEnabledCheckBox.isSelected());
        }

        if (speechUseAwsCheckBox != null) {
            OverlayPreferences.setSpeechUseAwsSynthesis(speechUseAwsCheckBox.isSelected());
        }

        if (speechEngineCombo != null && speechEngineCombo.getSelectedItem() != null) {
            OverlayPreferences.setSpeechEngine(speechEngineCombo.getSelectedItem().toString());
        }

        if (speechVoiceCombo != null && speechVoiceCombo.getSelectedItem() != null) {
            OverlayPreferences.setSpeechVoiceId(speechVoiceCombo.getSelectedItem().toString());
        }

        if (speechRegionField != null) {
            OverlayPreferences.setSpeechAwsRegion(speechRegionField.getText().trim());
        }

        if (speechAwsProfileField != null) {
            OverlayPreferences.setSpeechAwsProfile(speechAwsProfileField.getText().trim());
        }

        if (speechCacheDirField != null) {
            OverlayPreferences.setSpeechCacheDir(speechCacheDirField.getText().trim());
        }

        if (speechSampleRateField != null) {
            String s = speechSampleRateField.getText().trim();
            try {
                int hz = Integer.parseInt(s);
                OverlayPreferences.setSpeechSampleRateHz(hz);
            } catch (Exception e) {
                // ignore, keep previous/default
            }
        }

                // Fonts
        if (uiFontNameCombo != null) {
            Object sel = uiFontNameCombo.getSelectedItem();
            if (sel != null) {
                OverlayPreferences.setUiFontName(sel.toString());
            }
        }
        if (uiFontSizeSpinner != null) {
            try {
                int sz = ((Number) uiFontSizeSpinner.getValue()).intValue();
                OverlayPreferences.setUiFontSize(sz);
            } catch (Exception e) {
                // ignore
            }
        }

        
        // Colors
        if (uiMainTextColorButton != null) {
            OverlayPreferences.setUiMainTextRgb(colorToRgb(uiMainTextColorButton.getBackground()));
        }
        if (uiBackgroundColorButton != null) {
            int rgb = colorToRgb(uiBackgroundColorButton.getBackground());
            OverlayPreferences.setUiBackgroundRgb(rgb);

            // Keep the overlay background in sync with the UI theme background.
            // (Users can still override this in the Overlay tab later.)
            OverlayPreferences.setNormalBackgroundRgb(rgb);
            OverlayPreferences.setPassThroughBackgroundRgb(rgb);
        }

// Mining
        if (prospectorMaterialsField != null) {
            OverlayPreferences.setProspectorMaterialsCsv(prospectorMaterialsField.getText());
        }
        if (prospectorMinPropSpinner != null) {
            try {
                double p = ((Number) prospectorMinPropSpinner.getValue()).doubleValue();
                OverlayPreferences.setProspectorMinProportionPercent(p);
            } catch (Exception e) {
                // ignore
            }
        }

        if (prospectorMinAvgValueSpinner != null) {
            try {
                int v = ((Number) prospectorMinAvgValueSpinner.getValue()).intValue();
                OverlayPreferences.setProspectorMinAvgValueCrPerTon(v);
            } catch (Exception e) {
                // ignore
            }
        }

        if (miningLowLimpetReminderEnabledCheckBox != null) {
			OverlayPreferences.setMiningLowLimpetReminderEnabled(miningLowLimpetReminderEnabledCheckBox.isSelected());
		}

		if (miningLowLimpetReminderCountRadio != null && miningLowLimpetReminderPercentRadio != null) {
			if (miningLowLimpetReminderPercentRadio.isSelected()) {
				OverlayPreferences.setMiningLowLimpetReminderMode(OverlayPreferences.MiningLimpetReminderMode.PERCENT);
			} else {
				OverlayPreferences.setMiningLowLimpetReminderMode(OverlayPreferences.MiningLimpetReminderMode.COUNT);
			}
		}

		if (miningLowLimpetReminderThresholdSpinner != null) {
			try {
				int v = ((Number) miningLowLimpetReminderThresholdSpinner.getValue()).intValue();
				OverlayPreferences.setMiningLowLimpetReminderThreshold(v);
			} catch (Exception e) {
				// ignore
			}
		}

		if (miningLowLimpetReminderPercentSpinner != null) {
			try {
				int v = ((Number) miningLowLimpetReminderPercentSpinner.getValue()).intValue();
				OverlayPreferences.setMiningLowLimpetReminderThresholdPercent(v);
			} catch (Exception e) {
				// ignore
			}
		}

if (miningTonsLowSpinner != null) {
            try {
                double v = ((Number) miningTonsLowSpinner.getValue()).doubleValue();
                OverlayPreferences.setMiningEstimateTonsLow(v);
            } catch (Exception e) {
                // ignore
            }
        }
        if (miningTonsMediumSpinner != null) {
            try {
                double v = ((Number) miningTonsMediumSpinner.getValue()).doubleValue();
                OverlayPreferences.setMiningEstimateTonsMedium(v);
            } catch (Exception e) {
                // ignore
            }
        }
        if (miningTonsHighSpinner != null) {
            try {
                double v = ((Number) miningTonsHighSpinner.getValue()).doubleValue();
                OverlayPreferences.setMiningEstimateTonsHigh(v);
            } catch (Exception e) {
                // ignore
            }
        }
        if (miningTonsCoreSpinner != null) {
            try {
                double v = ((Number) miningTonsCoreSpinner.getValue()).doubleValue();
                OverlayPreferences.setMiningEstimateTonsCore(v);
            } catch (Exception e) {
                // ignore
            }
        }



        // Text notifications
        if (textNotificationsEnabledCheckBox != null) {
            OverlayPreferences.setTextNotificationsEnabled(textNotificationsEnabledCheckBox.isSelected());
        }
        if (textNotificationAddressField != null) {
            OverlayPreferences.setTextNotificationAddress(textNotificationAddressField.getText());
        }

// Other tabs can be wired into OverlayPreferences later as needed.
    }

    private void applyLiveOverlayBackgroundPreview(boolean passThroughSection) {
        if (!(getOwner() instanceof OverlayUiPreviewHost)) {
            return;
        }

        OverlayUiPreviewHost f = (OverlayUiPreviewHost) getOwner();
        // Only preview the section that corresponds to the overlay's current mode.
        if (f.isPassThroughEnabled() != passThroughSection) {
            return;
        }

        int rgb;
        int pct;
        if (passThroughSection) {
            rgb = colorToRgb(passThroughBgColorButton != null ? passThroughBgColorButton.getBackground() : Color.black);
            pct = passThroughTransparencySlider != null ? passThroughTransparencySlider.getValue() : 100;
        } else {
            rgb = colorToRgb(normalBgColorButton != null ? normalBgColorButton.getBackground() : Color.black);
            pct = normalTransparencySlider != null ? normalTransparencySlider.getValue() : 100;
        }

        f.applyOverlayBackgroundPreview(passThroughSection, rgb, pct);
    }

    private interface OverlaySectionBinder {
        void bind(JButton colorButton, JSlider transparencySlider, JLabel transparencyValueLabel);
    }

    private JPanel createOverlayAppearanceSection(
            String title,
            int initialRgb,
            int initialTransparencyPct,
            OverlaySectionBinder binder,
            Runnable onPreview
    ) {
        JPanel panel = new JPanel(new GridBagLayout());
        panel.setOpaque(false);
        panel.setBorder(BorderFactory.createTitledBorder(title));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.anchor = GridBagConstraints.WEST;
        gbc.insets = new Insets(4, 4, 4, 4);

        panel.add(new JLabel("Background color:"), gbc);

        gbc.gridx = 1;
        JButton colorBtn = new JButton("Choose...");
        colorBtn.setBackground(rgbToColor(initialRgb));
        colorBtn.setOpaque(true);
        colorBtn.addActionListener(e -> {
            Color chosen = JColorChooser.showDialog(this, "Choose background color", colorBtn.getBackground());
            if (chosen != null) {
                colorBtn.setBackground(chosen);
                if (onPreview != null) {
                    onPreview.run();
                }
            }
        });
        panel.add(colorBtn, gbc);

        gbc.gridx = 0;
        gbc.gridy++;
        panel.add(new JLabel("Transparency:"), gbc);

        gbc.gridx = 1;
        JSlider slider = new JSlider(0, 100, clampPct(initialTransparencyPct));
        slider.setPaintTicks(true);
        slider.setMajorTickSpacing(25);
        slider.setMinorTickSpacing(5);
        panel.add(slider, gbc);

        gbc.gridx = 2;
        JLabel valueLabel = new JLabel(slider.getValue() + "%");
        panel.add(valueLabel, gbc);

        slider.addChangeListener(new ChangeListener() {
            @Override
            public void stateChanged(ChangeEvent e) {
                valueLabel.setText(slider.getValue() + "%");
                if (!slider.getValueIsAdjusting() && onPreview != null) {
                    onPreview.run();
                }
            }
        });

        if (binder != null) {
            binder.bind(colorBtn, slider, valueLabel);
        }

        return panel;
    }

    private static int clampPct(int pct) {
        if (pct < 0) {
            return 0;
        }
        if (pct > 100) {
            return 100;
        }
        return pct;
    }

    private static Color rgbToColor(int rgb) {
        return EdoUi.rgb((rgb >> 16) & 0xFF, (rgb >> 8) & 0xFF, rgb & 0xFF);
    }

    private static int colorToRgb(Color c) {
        if (c == null) {
            return 0x000000;
        }
        return (c.getRed() << 16) | (c.getGreen() << 8) | c.getBlue();
    }

    private static String[] buildFunctionKeyChoices() {
        String[] keys = new String[12];
        for (int i = 0; i < 12; i++) {
            keys[i] = "F" + (i + 1);
        }
        return keys;
    }

    private static String keyCodeToDisplayString(int keyCode) {
        // Only map F1-F12 for now.
        switch (keyCode) {
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F1:
                return "F1";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F2:
                return "F2";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F3:
                return "F3";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F4:
                return "F4";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F5:
                return "F5";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F6:
                return "F6";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F7:
                return "F7";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F8:
                return "F8";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F9:
                return "F9";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F10:
                return "F10";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F11:
                return "F11";
            case com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F12:
                return "F12";
            default:
                return "F9";
        }
    }

    private static int displayStringToKeyCode(String display) {
        if (display == null) {
            return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F9;
        }
        String s = display.trim().toUpperCase();
        switch (s) {
            case "F1":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F1;
            case "F2":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F2;
            case "F3":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F3;
            case "F4":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F4;
            case "F5":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F5;
            case "F6":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F6;
            case "F7":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F7;
            case "F8":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F8;
            case "F9":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F9;
            case "F10":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F10;
            case "F11":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F11;
            case "F12":
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F12;
            default:
                return com.github.kwhat.jnativehook.keyboard.NativeKeyEvent.VC_F9;
        }
    }

}
